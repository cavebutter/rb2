RB2 OOTP Website - Session Continuity Guide

═══════════════════════════════════════════════════════════════════════════════
📈 CURRENT PROJECT STATUS (Session 19: 2025-10-14)
═══════════════════════════════════════════════════════════════════════════════

**Session 19 Summary - ORPHANED NATIONS ISSUE RESOLVED:**

**The Problem:**
After configuring filtered game export (Session 18), orphaned nation references blocked ETL:
- ✅ Reduced reference data: 24 nations, 443 states, 3,365 cities (97% reduction!)
- ❌ Players.csv references `second_nation_id=94` which doesn't exist in filtered nations.csv
- ❌ FK violation prevented all player and stats loading
- Game export cannot be fine-tuned further to include these orphaned nations

**Solution Implemented:**
Added automatic stub nation creation to ETL (similar to existing stub logic for leagues/teams):
- New method: `PlayersLoader._create_missing_nations()` at etl/src/loaders/players_loader.py:390
- Scans players.csv for ALL nation_id references (nation_id and second_nation_id)
- Creates stub nation records for any missing nation IDs before loading players
- Stub format: name="Nation {id}", abbr="N{id}", continent_id=1

**ETL Testing:**
- ✅ Full ETL pipeline run with fresh data export
- ✅ Stub nations created automatically for orphaned references
- ✅ Players and stats loaded successfully without FK violations
- ✅ No manual intervention required for future exports

**Lessons Learned:**
- Game exports may contain orphaned references that can't be filtered at source
- ETL should be resilient and auto-create stubs for missing reference data
- Pattern established: nations (new), leagues (existing), teams (existing)
- Stub creation prevents FK violations while maintaining data integrity

═══════════════════════════════════════════════════════════════════════════════
📈 PREVIOUS STATUS (Session 16: 2025-10-13)
═══════════════════════════════════════════════════════════════════════════════

**Progress: 55% (42/77 user stories complete) | ~81 hours**

**Completed Epics:**
- ✅ Epic 1: Player Pages - 100% (18/18 stories)
- ✅ Epic 2: Team Pages - 100% (5/5 stories)
- ✅ Epic 3: Leaderboards - 82% (9/11 stories, US-L008 deferred)
- ✅ Epic 5: League/Year Pages - 100% (2/2 stories)
- ✅ Epic 6: Search & Navigation - 100% (4/4 stories)

**In Progress:**
- 🟡 Epic 4: Front Page - 83% (5/6 stories, US-F005 deferred)
- 🟡 Epic 7: Infrastructure - ~35%

**Recent Completion (Session 16):**
- ✅ **EPIC 5 COMPLETE** - League and year pages fully functional!
- ✅ US-LY001: League Home Pages (standings, leaders, team stats)
- ✅ US-LY002: Year Summary Pages (historical standings, leaders, year navigation)
- 🎉 **Major Milestone:** All league and historical year pages complete!

═══════════════════════════════════════════════════════════════════════════════
🚨 CRITICAL PATTERNS & RULES
═══════════════════════════════════════════════════════════════════════════════

**SQLAlchemy Query Optimization (MANDATORY):**
```python
from sqlalchemy.orm import load_only, selectinload, raiseload, lazyload

# Minimal data queries
Player.query.options(load_only(Player.player_id, Player.first_name), raiseload('*'))

# With relationships
Team.query.options(selectinload(Team.league).raiseload('*'), raiseload('*'))

# Stats queries (prevent cascade)
PlayerBattingStats.query.options(lazyload('player'), lazyload('team'))

# Complex: Use raw SQL
db.session.execute(text("SELECT..."))
```

**Models with lazy='joined' (ALWAYS optimize):**
- Player: city_of_birth, nation, current_status
- Team: city, park, league, nation
- PlayerBattingStats/PlayerPitchingStats: player, team

**Critical Data Rules:**
- **ALWAYS filter team_id != 0** (excludes college/HS players from leaderboards)
- Applied at database (materialized views) AND service layer

**ETL Data Preservation (New):**
- `trade_history` and `messages` use incremental UPSERT (never delete)
- Configure filters in `/etl/config/etl_config.py` (MESSAGE_FILTERS)
- Images preserved via rsync --update flag
- See `/etl/docs/INCREMENTAL_LOADING.md` for details

═══════════════════════════════════════════════════════════════════════════════
📊 DATABASE & ENVIRONMENT
═══════════════════════════════════════════════════════════════════════════════

**Data State:**
- 18 seasons (1980-1997), current: June 1997 (in-season)
- Non-traditional league structure: 4 top-level leagues (not AL/NL)
- Images: `/etl/data/images/players/` (player_X.png, coach_X.png)
- venv: ~/virtual-envs/rb2
- App running on: http://localhost:5000

**Known Data Gaps:**
- Fielding stats empty (no ETL) - blocks US-P003
- Schools: No reference table - blocks US-P005
- Current season yearly leaders: Ranks populated, stat values NULL for 1997

**Key Components:**
- Context processor: `inject_game_date()` provides game date to all templates
- Breadcrumb macro: `/web/app/templates/_macros/breadcrumbs.html`
- Search service: `/web/app/services/search_service.py`
- Leaderboard service: `/web/app/services/leaderboard_service.py`

═══════════════════════════════════════════════════════════════════════════════
⚡ PERFORMANCE STANDARDS
═══════════════════════════════════════════════════════════════════════════════

**Target Benchmarks:**
- Detail pages: < 1s, < 20 queries
- List pages: < 500ms, < 15 queries
- Leaderboards: < 2s, < 30 queries

**Achieved:**
- Player detail: 171ms, 12 queries
- Home page: <100ms, 17 queries
- Team home: 120ms, 12 queries
- Leaderboards: <200ms (materialized views)

═══════════════════════════════════════════════════════════════════════════════
🔄 SESSION WORKFLOW
═══════════════════════════════════════════════════════════════════════════════

**Starting a Session:**
1. Read `docs/backlog-active.md` for current work
2. Review this file for critical patterns
3. Check current progress percentages

**Ending a Session:**
1. Update backlog with completed stories (mark DONE, add implementation notes)
2. Update this file with new patterns or critical discoveries only
3. Keep sessions focused: 4-8 hour blocks

**Key Files:**
- `docs/backlog-active.md` - Active work (incomplete epics only)
- `docs/backlog-completed.md` - Completed epics (Epics 1-3, 5-6, reference only)
- `docs/website-specs.md` - Original requirements
- `continuity.txt` - This file (patterns & current status)
