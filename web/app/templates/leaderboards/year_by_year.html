{% extends "base.html" %}

{% block title %}Year-by-Year {{ stat_name }} Leaders - RB2 Baseball{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Breadcrumb Navigation -->
    {% from "_macros/breadcrumbs.html" import breadcrumbs %}
    {{ breadcrumbs([
        ('Home', url_for('main.index')),
        ('Leaderboards', url_for('leaderboards.home')),
        ('Year-by-Year Top Tens', None)
    ]) }}

    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Year-by-Year Top Tens</h1>
        <p class="text-gray-600">{{ stat_name }} leaders for each season</p>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
        <form method="get" class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Category -->
            <div>
                <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                <select name="category" id="category" onchange="this.form.submit()"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="batting" {% if category == 'batting' %}selected{% endif %}>Batting</option>
                    <option value="pitching" {% if category == 'pitching' %}selected{% endif %}>Pitching</option>
                </select>
            </div>

            <!-- Stat -->
            <div>
                <label for="stat" class="block text-sm font-medium text-gray-700 mb-1">Statistic</label>
                <select name="stat" id="stat" onchange="this.form.submit()"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    {% for stat_key, stat_info in available_stats.items() %}
                    <option value="{{ stat_key }}" {% if stat_key == stat %}selected{% endif %}>
                        {{ stat_info.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- League -->
            <div>
                <label for="league" class="block text-sm font-medium text-gray-700 mb-1">League</label>
                <select name="league" id="league" onchange="this.form.submit()"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    {% for league in league_options %}
                    <option value="{{ league.league_id if league.league_id else '' }}"
                            {% if (league.league_id == league_id) or (not league_id and not league.league_id) %}selected{% endif %}>
                        {{ league.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </form>
    </div>

    <!-- Year-by-Year Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        {% for year in sorted_years %}
        {% set leaders = year_by_year_data[year] %}
        {% if leaders %}
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <!-- Year Header -->
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-4 py-3">
                <h3 class="text-lg font-bold">{{ year }}</h3>
            </div>

            <!-- #1 Leader (always visible) -->
            {% set leader1 = leaders[0] %}
            <div class="p-4 border-b border-gray-200 bg-yellow-50">
                <div class="flex items-start justify-between">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-1 mb-1">
                            <span class="text-2xl font-bold text-yellow-600">1</span>
                            <a href="{{ url_for('players.player_detail', player_id=leader1.player_id) }}"
                               class="text-blue-600 hover:text-blue-800 font-medium truncate">
                                {{ leader1.player_name }}
                                {% if leader1.is_active %}<span class="text-gray-500">*</span>{% endif %}
                            </a>
                        </div>
                        <div class="text-xs text-gray-600">
                            <a href="{{ url_for('teams.team_year', team_id=leader1.team_id, year=year) }}"
                               class="hover:text-blue-600">
                                {{ leader1.team_abbr }}
                            </a>
                        </div>
                    </div>
                    <div class="text-right ml-2">
                        <div class="text-2xl font-bold text-gray-900">
                            {% if stat_format == 'avg' %}
                                {{ "%.3f"|format(leader1.value) if leader1.value else '-' }}
                            {% elif stat_format in ['era', 'whip'] %}
                                {{ "%.2f"|format(leader1.value) if leader1.value else '-' }}
                            {% elif stat_format == 'decimal1' %}
                                {{ "%.1f"|format(leader1.value) if leader1.value else '-' }}
                            {% else %}
                                {{ leader1.value|int if leader1.value else '-' }}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Show #2-10 Toggle -->
            {% if leaders|length > 1 %}
            <div class="p-3 text-center border-b border-gray-200">
                <button onclick="toggleExpand('year-{{ year }}')"
                        class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                    <span id="expand-text-{{ year }}">Show #2-10 ▼</span>
                </button>
            </div>

            <!-- #2-10 Leaders (hidden by default) -->
            <div id="year-{{ year }}" class="hidden">
                <div class="divide-y divide-gray-200">
                    {% for leader in leaders[1:] %}
                    <div class="p-3 hover:bg-gray-50">
                        <div class="flex items-start justify-between">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center space-x-2 mb-1">
                                    <span class="text-sm font-semibold text-gray-600 w-6">{{ loop.index + 1 }}</span>
                                    <a href="{{ url_for('players.player_detail', player_id=leader.player_id) }}"
                                       class="text-sm text-blue-600 hover:text-blue-800 truncate">
                                        {{ leader.player_name }}
                                        {% if leader.is_active %}<span class="text-gray-500">*</span>{% endif %}
                                    </a>
                                </div>
                                <div class="text-xs text-gray-600 ml-8">
                                    <a href="{{ url_for('teams.team_year', team_id=leader.team_id, year=year) }}"
                                       class="hover:text-blue-600">
                                        {{ leader.team_abbr }}
                                    </a>
                                </div>
                            </div>
                            <div class="text-right ml-2">
                                <div class="text-sm font-semibold text-gray-900">
                                    {% if stat_format == 'avg' %}
                                        {{ "%.3f"|format(leader.value) if leader.value else '-' }}
                                    {% elif stat_format in ['era', 'whip'] %}
                                        {{ "%.2f"|format(leader.value) if leader.value else '-' }}
                                    {% elif stat_format == 'decimal1' %}
                                        {{ "%.1f"|format(leader.value) if leader.value else '-' }}
                                    {% else %}
                                        {{ leader.value|int if leader.value else '-' }}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}
        {% endfor %}
    </div>

    <!-- Legend -->
    <div class="mt-6 text-sm text-gray-600">
        <p>* Denotes active player</p>
    </div>
</div>

<script>
    function toggleExpand(yearId) {
        const element = document.getElementById(yearId);
        const textElement = document.getElementById('expand-text-' + yearId.replace('year-', ''));

        if (element.classList.contains('hidden')) {
            element.classList.remove('hidden');
            textElement.textContent = 'Hide #2-10 ▲';
        } else {
            element.classList.add('hidden');
            textElement.textContent = 'Show #2-10 ▼';
        }
    }
</script>
{% endblock %}
